# docker-compose.yml

version: '3.8'

services:
  # Servicio 1: El servidor Redis que ya tienes en tu VPS.
  # Docker Compose lo gestionará.
  redis:
    image: "redis:alpine"
    restart: always

  # Servicio 2: Tu aplicación web (Flask + Gunicorn)
  web:
    build: .  # Le dice a Docker que construya la imagen usando el Dockerfile de este directorio
    restart: always
    # El comando que Gunicorn ejecutará en producción
    command: gunicorn --bind 0.0.0.0:5000 --workers 4 app:app
    ports:
      - "5000:5000" # Mapea el puerto 5000 de tu VPS al puerto 5000 del contenedor
    environment:
      # Estas variables le dicen a tu app cómo encontrar Redis.
      # 'redis' es el nombre del servicio de arriba, Docker se encarga de la conexión.
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    # secrets/env_file: Dependerá de cómo Dockploy maneje las variables de entorno.
    # Generalmente, las configuras en el panel de control de Dockploy.
    depends_on:
      - redis # Le dice a este servicio que espere a que Redis esté listo antes de iniciar

  # Servicio 3: El worker de Celery
  worker:
    build: . # Usa la misma imagen que el servicio web. ¡No hay que construir dos veces!
    restart: always
    # El comando para iniciar el worker de Celery
    command: celery -A celery_worker.celery worker --loglevel=info
    environment:
      # El worker también necesita saber dónde está Redis
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    # También necesitará acceso a tus claves de API que configures en Dockploy
    depends_on:
      - redis # También espera a que Redis esté listo